<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Solicitações de Arte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyC3o6GHl2LwAs1vREbXOuaP9BhoOUmjAH8",
          authDomain: "gestao-de-artes---rigolim.firebaseapp.com",
          projectId: "gestao-de-artes---rigolim",
          storageBucket: "gestao-de-artes---rigolim.appspot.com",
          messagingSenderId: "641611102306",
          appId: "1:641611102306:web:08f4b1fd2db251ee6ff93b"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Ícones (Lucide React) ---
        const Plus = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14" /><path d="M12 5v14" /></svg>);
        const X = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>);
        const Trash2 = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>);
        const UserIcon = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>);
        const LogOut = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>);
        const CalendarIcon = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>);
        const Columns = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M12 3v18" /></svg>);
        const CalendarDays = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /><path d="M8 14h.01" /><path d="M12 14h.01" /><path d="M16 14h.01" /><path d="M8 18h.01" /><path d="M12 18h.01" /><path d="M16 18h.01" /></svg>);
        const CheckCircle2 = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>);
        const RefreshCw = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>);
        const Copy = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>);
        const ChevronLeft = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6"/></svg>);
        const ChevronRight = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"/></svg>);
        const Download = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>);
        const Settings = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const Send = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>);
        
        // --- COMPONENTES (DEFINIDOS NA ORDEM CORRETA) ---

        const TaskFormModal = ({ user, onClose, onSave, initialData = null }) => {
            const [title, setTitle] = useState(initialData?.title || '');
            const [description, setDescription] = useState(initialData?.description || '');
            const [dueDate, setDueDate] = useState(initialData?.dueDate ? new Date(initialData.dueDate.seconds * 1000).toISOString().split('T')[0] : '');
            const [priority, setPriority] = useState(initialData?.priority || 'Média');
            const [artType, setArtType] = useState(initialData?.artType || '');
            const [attachments, setAttachments] = useState(initialData?.attachments || '');

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!title.trim()) return; 
                onSave({ 
                    title: title.toUpperCase(), 
                    description: description.toUpperCase(), 
                    requester: user.email.split('@')[0],
                    dueDate: dueDate ? new Date(dueDate) : null, 
                    priority, 
                    artType: artType.toUpperCase(),
                    attachments 
                }); 
            };
            return (<div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl relative max-h-[90vh] overflow-y-auto"><h2 className="text-2xl font-bold mb-4">{initialData ? "Duplicar Solicitação" : "Nova Solicitação de Arte"}</h2><button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><X className="h-6 w-6" /></button><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">Título</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full border border-gray-300 rounded-md p-2 uppercase" placeholder="Ex: Arte para post do Instagram" required /></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">Data de Entrega</label><input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} className="w-full border border-gray-300 rounded-md p-2"/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Prioridade</label><select value={priority} onChange={e => setPriority(e.target.value)} className="w-full border border-gray-300 rounded-md p-2"><option>Baixa</option><option>Média</option><option>Alta</option></select></div></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Tipo de Arte</label><input type="text" value={artType} onChange={e => setArtType(e.target.value)} className="w-full border border-gray-300 rounded-md p-2 uppercase" placeholder="Ex: Post para Feed, Story"/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea value={description} onChange={e => setDescription(e.target.value)} rows="4" className="w-full border border-gray-300 rounded-md p-2 uppercase" placeholder="Descreva os detalhes..."></textarea></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Anexos de Referência (links)</label><textarea value={attachments} onChange={e => setAttachments(e.target.value)} rows="3" className="w-full border border-gray-300 rounded-md p-2" placeholder="https://drive.google.com/..."></textarea></div><div className="flex justify-end gap-3 pt-4"><button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button></div></form></div></div>);
        };
        
        const ConfirmationModal = ({ message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                    <h3 className="text-lg font-medium text-gray-900 mb-4">{message}</h3>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="button" onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Excluir</button>
                    </div>
                </div>
            </div>
        );
        
        const SettingsModal = ({ currentSettings, onSave, onClose }) => {
            const [companyName, setCompanyName] = useState(currentSettings.companyName);
            const [logoUrl, setLogoUrl] = useState(currentSettings.logoUrl);
            const [isUploading, setIsUploading] = useState(false);

            const handleLogoUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=4d27fe0cc1acd80eabd5fe7118fd1c03`, {
                        method: 'POST',
                        body: formData,
                    });
                    const result = await response.json();
                    if (result.success) {
                        setLogoUrl(result.data.url);
                    } else {
                        throw new Error(result.error.message);
                    }
                } catch (error) {
                    console.error("Erro no upload do logo:", error);
                    alert("Ocorreu um erro ao enviar o logo.");
                } finally {
                    setIsUploading(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ companyName, logoUrl });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg relative">
                        <h2 className="text-2xl font-bold mb-4">Configurações</h2>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><X className="h-6 w-6" /></button>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label>
                                <input type="text" value={companyName} onChange={e => setCompanyName(e.target.value)} className="w-full border border-gray-300 rounded-md p-2"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Logo</label>
                                <input type="file" onChange={handleLogoUpload} accept="image/png, image/jpeg" className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                                {isUploading && <p className="text-sm text-yellow-700 mt-2">A enviar logo...</p>}
                                {logoUrl && <img src={logoUrl} alt="Preview do Logo" className="mt-4 h-16" />}
                            </div>
                            <div className="flex justify-end gap-3 pt-4 border-t">
                                <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                <button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const TaskDetailModal = ({ user, task: initialTask, onClose, onUpdate, onDelete }) => {
            // ... (código do componente TaskDetailModal permanece o mesmo)
        };

        const CalendarView = ({ tasks, onTaskClick }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = [];
            for (let i = 0; i < firstDayOfMonth.getDay(); i++) { daysInMonth.push({ date: null, isCurrentMonth: false }); }
            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) { daysInMonth.push({ date: new Date(currentDate.getFullYear(), currentDate.getMonth(), i), isCurrentMonth: true }); }
            const changeMonth = (offset) => { setCurrentDate(prevDate => new Date(prevDate.getFullYear(), prevDate.getMonth() + offset, 1)); };
            const normalizeDate = (date) => { const d = new Date(date); d.setHours(0, 0, 0, 0); return d; };
            return (<div className="bg-white p-4 rounded-lg shadow-md"><div className="flex justify-between items-center mb-4"><button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-200"><ChevronLeft/></button><h2 className="text-xl font-bold">{currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase())}</h2><button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-200"><ChevronRight/></button></div><div className="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600">{daysOfWeek.map(day => <div key={day} className="py-2">{day}</div>)}</div><div className="grid grid-cols-7 gap-1">{daysInMonth.map((day, index) => { const tasksForDay = day.date ? tasks.filter(task => { if (!task.dueDate?.seconds) return false; const taskDate = new Date(task.dueDate.seconds * 1000); const adjustedTaskDate = new Date(taskDate.getTime() + taskDate.getTimezoneOffset() * 60000); return normalizeDate(adjustedTaskDate).getTime() === normalizeDate(day.date).getTime(); }) : []; return (<div key={index} className={`border rounded-md h-32 p-1.5 ${day.isCurrentMonth ? 'bg-white' : 'bg-gray-50'}`}>{day.date && <span className={`text-sm ${new Date().toDateString() === day.date.toDateString() ? 'bg-blue-500 text-white rounded-full h-6 w-6 flex items-center justify-center' : ''}`}>{day.date.getDate()}</span>}<div className="mt-1 space-y-1 overflow-y-auto max-h-20">{tasksForDay.map(task => (<div key={task.id} onClick={() => onTaskClick(task)} className="bg-blue-100 text-blue-800 text-xs p-1 rounded-md truncate cursor-pointer hover:bg-blue-200">{task.title}</div>))}</div></div>); })}</div></div>);
        };

        const TaskCard = ({ task, onClick, onDuplicate }) => {
            const formatDate = (timestamp) => { 
                if (!timestamp) return 'Sem data'; 
                const date = new Date(timestamp.seconds * 1000); 
                const userTimezoneOffset = date.getTimezoneOffset() * 60000; 
                return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR'); 
            };
            const priorityColors = { 'Alta': 'bg-red-500', 'Média': 'bg-yellow-500', 'Baixa': 'bg-green-500' };

            const handleDuplicateClick = (e) => {
                e.stopPropagation();
                onDuplicate(task.id);
            };

            return (
                <div onClick={onClick} className="bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border-l-4 border-gray-300 relative group">
                    <div className="flex justify-between items-start"><h3 className="font-semibold mb-2 pr-2">{task.title}</h3>{task.priority && <span className={`h-3 w-3 rounded-full ${priorityColors[task.priority]} flex-shrink-0 mt-1`} title={`Prioridade ${task.priority}`}></span>}</div>
                    {task.artType && <p className="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded-full mb-2">{task.artType}</p>}
                    <div className="flex flex-col text-sm text-gray-500 mt-2 space-y-1">
                        <div className="flex items-center gap-1"><CalendarIcon className="h-4 w-4" /><span>{formatDate(task.dueDate)}</span></div>
                        <div className="flex items-center gap-1"><UserIcon className="w-4 h-4" /><span>{task.requester || 'N/A'}</span></div>
                    </div>
                    {task.status === 'A Fazer' && (<button onClick={handleDuplicateClick} className="absolute bottom-2 right-2 p-1.5 rounded-full bg-blue-500 text-white opacity-0 group-hover:opacity-100 transition-opacity" title="Duplicar Tarefa"><Copy className="h-4 h-4" /></button>)}
                </div>
            );
        };
        
        const TaskManager = ({ user }) => {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [taskToDuplicate, setTaskToDuplicate] = useState(null);
            const [selectedTask, setSelectedTask] = useState(null);
            const [view, setView] = useState('board');
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [taskToDelete, setTaskToDelete] = useState(null);
            const [settings, setSettings] = useState({ companyName: "RIGOLIM HAIR AND CO", logoUrl: "" });

            const tasksCollectionPath = "tasks";
            const settingsDocPath = "settings/config";

            useEffect(() => {
                const unsubscribeTasks = db.collection(tasksCollectionPath).onSnapshot((querySnapshot) => {
                    const tasksData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(tasksData);
                    setLoading(false);
                }, (error) => { console.error("Erro ao buscar tarefas: ", error); setLoading(false); });

                const unsubscribeSettings = db.doc(settingsDocPath).onSnapshot((doc) => {
                    if (doc.exists) {
                        setSettings(doc.data());
                    }
                });

                return () => { unsubscribeTasks(); unsubscribeSettings(); };
            }, []);

            const handleAddTask = async (taskData) => {
                try {
                    await db.collection(tasksCollectionPath).add({ ...taskData, status: 'A Fazer', createdAt: firebase.firestore.FieldValue.serverTimestamp(), approvalAttachments: [] });
                    closeAllModals();
                } catch (error) { console.error("Erro ao adicionar tarefa: ", error); }
            };

            const handleUpdateTask = async (taskId, updatedData) => {
                const taskDoc = db.collection(tasksCollectionPath).doc(taskId);
                try { await taskDoc.update(updatedData); } 
                catch (error) { console.error("Erro ao atualizar tarefa: ", error); alert("Ocorreu um erro ao salvar a tarefa."); }
            };
            
            const handleSaveSettings = async (newSettings) => {
                try {
                    await db.doc(settingsDocPath).set(newSettings, { merge: true });
                    setIsSettingsModalOpen(false);
                } catch (error) {
                    console.error("Erro ao salvar configurações:", error);
                    alert("Ocorreu um erro ao salvar as configurações.");
                }
            };

            const handleDuplicateTask = (taskId) => {
                const originalTask = tasks.find(t => t.id === taskId);
                if(originalTask){
                    const { id, createdAt, status, ...restOfTask } = originalTask;
                    const duplicatedTaskData = {
                        ...restOfTask,
                        requester: user.email.split('@')[0],
                        title: `[CÓPIA] ${originalTask.title}`,
                    };
                    delete duplicatedTaskData.approvalAttachments;
                    setTaskToDuplicate(duplicatedTaskData);
                    setIsFormModalOpen(true);
                }
            };
            
            const confirmDeleteTask = (taskId) => { setTaskToDelete(taskId); setIsDeleteModalOpen(true); };

            const handleDeleteTask = async () => {
                if (!taskToDelete) return;
                await db.collection(tasksCollectionPath).doc(taskToDelete).delete();
                closeAllModals();
            };
            
            const openTaskDetails = (task) => setSelectedTask(task);
            const closeAllModals = () => {
                setIsFormModalOpen(false);
                setSelectedTask(null);
                setIsDeleteModalOpen(false);
                setTaskToDelete(null);
                setTaskToDuplicate(null);
                setIsSettingsModalOpen(false);
            };

            const columnNames = ['A Fazer', 'Em Andamento', 'Em Aprovação', 'Concluído'];
            
            const columnStyles = {
                'A Fazer': 'bg-blue-100 border-blue-400',
                'Em Andamento': 'bg-yellow-100 border-yellow-400',
                'Em Aprovação': 'bg-purple-100 border-purple-400',
                'Concluído': 'bg-green-100 border-green-400',
            };

            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-800">
                    <header className="bg-white shadow-md p-4 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-40">
                        <div className="flex items-center gap-4">
                            {settings.logoUrl && <img src={settings.logoUrl} alt="Logo" className="h-10" />}
                            <div>
                                <h1 className="text-xl md:text-2xl font-bold text-gray-700">{settings.companyName}</h1>
                                <p className="text-sm text-gray-500">Sistema de Gerenciamento de Artes</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center justify-center gap-2">
                             <div className="flex items-center bg-gray-200 rounded-lg p-1">
                                <button onClick={() => setView('board')} className={`flex items-center gap-2 py-1 px-3 rounded-md text-sm transition-colors ${view === 'board' ? 'bg-white shadow-sm' : 'hover:bg-gray-300'}`}><Columns className="h-5 w-5"/> Quadro</button>
                                 <button onClick={() => setView('calendar')} className={`flex items-center gap-2 py-1 px-3 rounded-md text-sm transition-colors ${view === 'calendar' ? 'bg-white shadow-sm' : 'hover:bg-gray-300'}`}><CalendarDays className="h-5 w-5"/> Calendário</button>
                            </div>
                            <button onClick={() => setIsFormModalOpen(true)} className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105"><Plus className="h-5 w-5" /> Nova Solicitação</button>
                             {user.email === 'andercleidesigner@gmail.com' && (
                                <button onClick={() => setIsSettingsModalOpen(true)} className="p-2 rounded-full hover:bg-gray-200" title="Configurações"><Settings className="h-5 w-5"/></button>
                             )}
                             <button onClick={() => auth.signOut()} className="flex items-center gap-2 text-red-500 hover:text-red-700 font-semibold"><LogOut className="h-5 w-5"/> Sair</button>
                        </div>
                    </header>

                    {loading ? <div className="flex justify-center items-center h-[calc(100vh-80px)]"><p>A carregar tarefas...</p></div> : (
                        <main className="p-4 md:p-8">
                            {view === 'board' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {columnNames.map(columnName => (
                                        <div key={columnName} className={`rounded-lg ${columnStyles[columnName]} p-1`}>
                                           <div className="p-3">
                                                <h2 className="font-bold text-lg mb-4 text-gray-700">{columnName} ({tasks.filter(t => t.status === columnName).length})</h2>
                                                <div className="space-y-4">
                                                    {tasks
                                                        .filter(t => t.status === columnName)
                                                        .sort((a, b) => {
                                                            if (!a.dueDate) return 1;
                                                            if (!b.dueDate) return -1;
                                                            return a.dueDate.seconds - b.dueDate.seconds;
                                                        })
                                                        .map(task => <TaskCard key={task.id} task={task} onDuplicate={handleDuplicateTask} onClick={() => openTaskDetails(task)} />)
                                                    }
                                                </div>
                                           </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {view === 'calendar' && <CalendarView tasks={tasks} onTaskClick={openTaskDetails} />}
                        </main>
                    )}

                    {isFormModalOpen && <TaskFormModal user={user} onClose={closeAllModals} onSave={handleAddTask} initialData={taskToDuplicate}/>}
                    {selectedTask && <TaskDetailModal user={user} task={selectedTask} onClose={closeAllModals} onUpdate={handleUpdateTask} onDelete={confirmDeleteTask}/>}
                    {isDeleteModalOpen && <ConfirmationModal message="Tem certeza que deseja excluir esta tarefa?" onConfirm={handleDeleteTask} onCancel={closeAllModals} />}
                    {isSettingsModalOpen && <SettingsModal currentSettings={settings} onSave={handleSaveSettings} onClose={closeAllModals} />}
                </div>
            );
        };
        
        const AuthScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                try {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold text-center">Login</h2>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="text-sm font-bold text-gray-600 block">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md mt-1" required />
                            </div>
                             <div>
                                <label className="text-sm font-bold text-gray-600 block">Senha</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md mt-1" required />
                            </div>
                            {error && <p className="text-sm text-red-500">{error}</p>}
                            <div>
                                <button type="submit" disabled={isLoading} className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-md text-white text-sm disabled:opacity-50">
                                    {isLoading ? 'A entrar...' : 'Entrar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return <div className="flex justify-center items-center h-screen"><p>A carregar...</p></div>;
            }

            return user ? <TaskManager user={user} /> : <AuthScreen />;
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
