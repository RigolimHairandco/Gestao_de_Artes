<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Solicitações de Arte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            setPersistence, 
            browserLocalPersistence,
            signOut as firebaseSignOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            setDoc,
            serverTimestamp,
            query,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyC3o6GHl2LwAs1vREbXOuaP9BhoOUmjAH8",
          authDomain: "gestao-de-artes---rigolim.firebaseapp.com",
          projectId: "gestao-de-artes---rigolim",
          storageBucket: "gestao-de-artes---rigolim.appspot.com",
          messagingSenderId: "641611102306",
          appId: "1:641611102306:web:08f4b1fd2db251ee6ff93b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Ícones (Lucide React as SVG Components) ---
        const Plus = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14" /><path d="M12 5v14" /></svg>);
        const X = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>);
        const Trash2 = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>);
        const UserIcon = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>);
        const LogOut = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>);
        const CalendarIcon = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>);
        const Columns = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M12 3v18" /></svg>);
        const CalendarDays = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /><path d="M8 14h.01" /><path d="M12 14h.01" /><path d="M16 14h.01" /><path d="M8 18h.01" /><path d="M12 18h.01" /><path d="M16 18h.01" /></svg>);
        const Copy = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>);
        const ChevronLeft = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6"/></svg>);
        const ChevronRight = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"/></svg>);
        const Settings = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const Send = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>);
        const LinkIcon = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>);
        const MessageSquare = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>);
        
        // --- Helper Functions ---
        const formatDate = (timestamp) => {
            if (!timestamp?.seconds) return 'Sem data';
            const date = new Date(timestamp.seconds * 1000);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR');
        };

        const formatDateTime = (timestamp) => {
            if (!timestamp?.seconds) return '';
            return new Date(timestamp.seconds * 1000).toLocaleString('pt-BR');
        };

        // --- React Components ---

        const TaskFormModal = ({ user, onClose, onSave, initialData = null }) => {
            const [title, setTitle] = useState(initialData?.title || '');
            const [description, setDescription] = useState(initialData?.description || '');
            const [dueDate, setDueDate] = useState(initialData?.dueDate ? new Date(initialData.dueDate.seconds * 1000).toISOString().split('T')[0] : '');
            const [priority, setPriority] = useState(initialData?.priority || 'Média');
            const [artType, setArtType] = useState(initialData?.artType || '');
            const [attachments, setAttachments] = useState(initialData?.attachments || '');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!title.trim()) return;
                onSave({
                    title: title.toUpperCase(),
                    description: description.toUpperCase(),
                    requester: user.email.split('@')[0],
                    dueDate: dueDate ? new Date(dueDate) : null,
                    priority,
                    artType: artType.toUpperCase(),
                    attachments
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl relative max-h-[90vh] overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-4">{initialData ? "Duplicar Solicitação" : "Nova Solicitação de Arte"}</h2>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><X className="h-6 w-6" /></button>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Título</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full border border-gray-300 rounded-md p-2 uppercase" placeholder="Ex: Arte para post do Instagram" required /></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Data de Entrega</label><input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} className="w-full border border-gray-300 rounded-md p-2"/></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Prioridade</label><select value={priority} onChange={e => setPriority(e.target.value)} className="w-full border border-gray-300 rounded-md p-2"><option>Baixa</option><option>Média</option><option>Alta</option></select></div>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Tipo de Arte</label><input type="text" value={artType} onChange={e => setArtType(e.target.value)} className="w-full border border-gray-300 rounded-md p-2 uppercase" placeholder="Ex: Post para Feed, Story"/></div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea value={description} onChange={e => setDescription(e.target.value)} rows="4" className="w-full border border-gray-300 rounded-md p-2 uppercase" placeholder="Descreva os detalhes..."></textarea></div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Anexos de Referência (links)</label><textarea value={attachments} onChange={e => setAttachments(e.target.value)} rows="3" className="w-full border border-gray-300 rounded-md p-2" placeholder="Cole os links aqui, um por linha..."></textarea></div>
                            <div className="flex justify-end gap-3 pt-4"><button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button></div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const ConfirmationModal = ({ message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                    <h3 className="text-lg font-medium text-gray-900 mb-4">{message}</h3>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="button" onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Excluir</button>
                    </div>
                </div>
            </div>
        );
        
        const SettingsModal = ({ currentSettings, onSave, onClose }) => {
            const [companyName, setCompanyName] = useState(currentSettings.companyName);
            const [logoUrl, setLogoUrl] = useState(currentSettings.logoUrl);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ companyName, logoUrl });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg relative">
                        <h2 className="text-2xl font-bold mb-4">Configurações</h2>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><X className="h-6 w-6" /></button>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label>
                                <input type="text" value={companyName} onChange={e => setCompanyName(e.target.value)} className="w-full border border-gray-300 rounded-md p-2"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">URL do Logo</label>
                                <input type="text" value={logoUrl} onChange={e => setLogoUrl(e.target.value)} className="w-full border border-gray-300 rounded-md p-2" placeholder="https://exemplo.com/logo.png"/>
                                {logoUrl && <img src={logoUrl} alt="Preview do Logo" className="mt-4 h-16" />}
                            </div>
                            <div className="flex justify-end gap-3 pt-4 border-t">
                                <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                <button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const TaskDetailModal = ({ user, task, onClose, onUpdate, onDelete }) => {
            const [status, setStatus] = useState(task.status);
            const [newComment, setNewComment] = useState("");
            const [newAttachment, setNewAttachment] = useState("");
            const commentsEndRef = useRef(null);

            const columnNames = ['A Fazer', 'Em Andamento', 'Em Aprovação', 'Concluído'];

            useEffect(() => {
                commentsEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [task.comments]);

            const handleStatusChange = (newStatus) => {
                setStatus(newStatus);
                onUpdate(task.id, { status: newStatus });
            };

            const handleAddComment = (e) => {
                e.preventDefault();
                if (newComment.trim() === "") return;
                const commentData = {
                    text: newComment,
                    author: user.email.split('@')[0],
                    createdAt: serverTimestamp()
                };
                onUpdate(task.id, { comments: arrayUnion(commentData) });
                setNewComment("");
            };

            const handleAddAttachment = (e) => {
                e.preventDefault();
                if (newAttachment.trim() === "") return;
                onUpdate(task.id, { approvalAttachments: arrayUnion(newAttachment) });
                setNewAttachment("");
            };

            const renderLinks = (text) => {
                 if (!text) return null;
                 const urlRegex = /(https?:\/\/[^\s]+)/g;
                 return text.split('\n').map((part, i) => 
                     <p key={i}>{part.split(urlRegex).map((subPart, j) => 
                         urlRegex.test(subPart) ? <a href={subPart} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all">{subPart}</a> : subPart
                     )}</p>
                 );
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl relative max-h-[90vh] flex flex-col">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><X className="h-6 w-6" /></button>
                        <div className="flex-grow overflow-y-auto pr-4 -mr-4">
                            <div className="flex flex-col md:flex-row gap-8">
                                {/* Coluna Esquerda: Detalhes */}
                                <div className="w-full md:w-2/3">
                                    <h2 className="text-3xl font-bold mb-2">{task.title}</h2>
                                    <div className="flex items-center gap-4 text-sm text-gray-500 mb-4">
                                        <span>Solicitado por: <strong>{task.requester}</strong></span>
                                        <span>Criado em: <strong>{formatDateTime(task.createdAt)}</strong></span>
                                    </div>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select value={status} onChange={e => handleStatusChange(e.target.value)} className="w-full md:w-1/2 border border-gray-300 rounded-md p-2">
                                            {columnNames.map(name => <option key={name} value={name}>{name}</option>)}
                                        </select>
                                    </div>

                                    <div className="space-y-4">
                                        <div><h4 className="font-semibold">Descrição</h4><div className="prose prose-sm max-w-none mt-1 text-gray-600">{renderLinks(task.description) || <p>Nenhuma descrição fornecida.</p>}</div></div>
                                        <div><h4 className="font-semibold">Tipo de Arte</h4><p className="mt-1 text-gray-600">{task.artType || 'N/A'}</p></div>
                                        <div><h4 className="font-semibold">Anexos de Referência</h4><div className="prose prose-sm max-w-none mt-1 text-gray-600">{renderLinks(task.attachments) || <p>Nenhum anexo de referência.</p>}</div></div>
                                        <div><h4 className="font-semibold">Anexos para Aprovação</h4>
                                            {task.approvalAttachments?.length > 0 ? renderLinks(task.approvalAttachments.join('\n')) : <p className="mt-1 text-gray-600">Nenhum anexo para aprovação.</p>}
                                            <form onSubmit={handleAddAttachment} className="flex gap-2 mt-2">
                                                <input type="text" value={newAttachment} onChange={e => setNewAttachment(e.target.value)} className="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Cole o link do anexo aqui..." />
                                                <button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-lg"><Send className="h-5 w-5"/></button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {/* Coluna Direita: Comentários e Infos */}
                                <div className="w-full md:w-1/3 bg-gray-50 p-4 rounded-lg flex flex-col">
                                    <div className="space-y-3 mb-4">
                                        <div className="flex items-center gap-2"><CalendarIcon className="h-5 w-5 text-gray-500"/><p>Entrega: <span className="font-semibold">{formatDate(task.dueDate)}</span></p></div>
                                        <div className="flex items-center gap-2"><div className={`h-4 w-4 rounded-full ${{'Alta': 'bg-red-500', 'Média': 'bg-yellow-500', 'Baixa': 'bg-green-500'}[task.priority]}`}></div><p>Prioridade: <span className="font-semibold">{task.priority}</span></p></div>
                                    </div>
                                    <hr className="my-2"/>
                                    <h4 className="font-semibold mb-2 flex items-center gap-2"><MessageSquare className="h-5 w-5"/> Comentários</h4>
                                    <div className="flex-grow space-y-3 overflow-y-auto mb-2 text-sm">
                                        {task.comments?.map((comment, index) => (
                                            <div key={index} className="bg-white p-2 rounded-md shadow-sm">
                                                <p className="text-gray-800">{comment.text}</p>
                                                <p className="text-xs text-gray-400 text-right mt-1"><strong>{comment.author}</strong> - {formatDateTime(comment.createdAt)}</p>
                                            </div>
                                        ))}
                                        <div ref={commentsEndRef} />
                                    </div>
                                    <form onSubmit={handleAddComment} className="flex gap-2 mt-auto">
                                        <input type="text" value={newComment} onChange={e => setNewComment(e.target.value)} className="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Adicionar comentário..." />
                                        <button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-lg"><Send className="h-5 w-5"/></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div className="flex-shrink-0 pt-4 mt-4 border-t flex justify-end">
                            <button onClick={() => onDelete(task.id)} className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg"><Trash2 className="h-5 w-5"/> Excluir Tarefa</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ tasks, onTaskClick }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = [];
            for (let i = 0; i < firstDayOfMonth.getDay(); i++) { daysInMonth.push({ date: null, isCurrentMonth: false }); }
            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) { daysInMonth.push({ date: new Date(currentDate.getFullYear(), currentDate.getMonth(), i), isCurrentMonth: true }); }
            const changeMonth = (offset) => { setCurrentDate(prevDate => new Date(prevDate.getFullYear(), prevDate.getMonth() + offset, 1)); };
            const normalizeDate = (date) => { const d = new Date(date); d.setHours(0, 0, 0, 0); return d; };
            return (<div className="bg-white p-4 rounded-lg shadow-md"><div className="flex justify-between items-center mb-4"><button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-200"><ChevronLeft/></button><h2 className="text-xl font-bold">{currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase())}</h2><button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-200"><ChevronRight/></button></div><div className="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600">{daysOfWeek.map(day => <div key={day} className="py-2">{day}</div>)}</div><div className="grid grid-cols-7 gap-1">{daysInMonth.map((day, index) => { const tasksForDay = day.date ? tasks.filter(task => { if (!task.dueDate?.seconds) return false; const taskDate = new Date(task.dueDate.seconds * 1000); const adjustedTaskDate = new Date(taskDate.getTime() + taskDate.getTimezoneOffset() * 60000); return normalizeDate(adjustedTaskDate).getTime() === normalizeDate(day.date).getTime(); }) : []; return (<div key={index} className={`border rounded-md h-32 p-1.5 ${day.isCurrentMonth ? 'bg-white' : 'bg-gray-50'}`}>{day.date && <span className={`text-sm ${new Date().toDateString() === day.date.toDateString() ? 'bg-blue-500 text-white rounded-full h-6 w-6 flex items-center justify-center' : ''}`}>{day.date.getDate()}</span>}<div className="mt-1 space-y-1 overflow-y-auto max-h-20">{tasksForDay.map(task => (<div key={task.id} onClick={() => onTaskClick(task)} className="bg-blue-100 text-blue-800 text-xs p-1 rounded-md truncate cursor-pointer hover:bg-blue-200">{task.title}</div>))}</div></div>); })}</div></div>);
        };

        const TaskCard = ({ task, onClick, onDuplicate }) => {
            const priorityColors = { 'Alta': 'bg-red-500', 'Média': 'bg-yellow-500', 'Baixa': 'bg-green-500' };

            const handleDuplicateClick = (e) => {
                e.stopPropagation();
                onDuplicate(task.id);
            };

            return (
                <div onClick={onClick} className="bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border-l-4 border-gray-300 relative group">
                    <div className="flex justify-between items-start"><h3 className="font-semibold mb-2 pr-2">{task.title}</h3>{task.priority && <span className={`h-3 w-3 rounded-full ${priorityColors[task.priority]} flex-shrink-0 mt-1`} title={`Prioridade ${task.priority}`}></span>}</div>
                    {task.artType && <p className="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded-full mb-2">{task.artType}</p>}
                    <div className="flex flex-col text-sm text-gray-500 mt-2 space-y-1">
                        <div className="flex items-center gap-1"><CalendarIcon className="h-4 w-4" /><span>{formatDate(task.dueDate)}</span></div>
                        <div className="flex items-center gap-1"><UserIcon className="w-4 h-4" /><span>{task.requester || 'N/A'}</span></div>
                    </div>
                    {task.status === 'A Fazer' && (<button onClick={handleDuplicateClick} className="absolute bottom-2 right-2 p-1.5 rounded-full bg-blue-500 text-white opacity-0 group-hover:opacity-100 transition-opacity" title="Duplicar Tarefa"><Copy className="h-4 h-4" /></button>)}
                </div>
            );
        };
        
        const TaskManager = ({ user }) => {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [taskToDuplicate, setTaskToDuplicate] = useState(null);
            const [selectedTask, setSelectedTask] = useState(null);
            const [view, setView] = useState('board');
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [taskToDelete, setTaskToDelete] = useState(null);
            const [settings, setSettings] = useState({ companyName: "Sua Empresa", logoUrl: "" });

            const tasksCollectionRef = collection(db, "tasks");
            const settingsDocRef = doc(db, "settings", "config");

            useEffect(() => {
                const q = query(tasksCollectionRef);
                const unsubscribeTasks = onSnapshot(q, (querySnapshot) => {
                    const tasksData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(tasksData);
                    setLoading(false);
                }, (error) => { console.error("Erro ao buscar tarefas: ", error); setLoading(false); });

                const unsubscribeSettings = onSnapshot(settingsDocRef, (doc) => {
                    if (doc.exists()) {
                        setSettings(doc.data());
                    }
                });

                return () => { unsubscribeTasks(); unsubscribeSettings(); };
            }, []);

            const handleAddTask = async (taskData) => {
                try {
                    await addDoc(tasksCollectionRef, { 
                        ...taskData, 
                        status: 'A Fazer', 
                        createdAt: serverTimestamp(), 
                        comments: [],
                        approvalAttachments: [] 
                    });
                    closeAllModals();
                } catch (error) { console.error("Erro ao adicionar tarefa: ", error); }
            };

            const handleUpdateTask = async (taskId, updatedData) => {
                const taskDocRef = doc(db, "tasks", taskId);
                try { 
                    await updateDoc(taskDocRef, updatedData); 
                } catch (error) { 
                    console.error("Erro ao atualizar tarefa: ", error); 
                }
            };
            
            const handleSaveSettings = async (newSettings) => {
                try {
                    await setDoc(settingsDocRef, newSettings, { merge: true });
                    setIsSettingsModalOpen(false);
                } catch (error) {
                    console.error("Erro ao salvar configurações:", error);
                }
            };

            const handleDuplicateTask = (taskId) => {
                const originalTask = tasks.find(t => t.id === taskId);
                if(originalTask){
                    const { id, createdAt, status, comments, approvalAttachments, ...restOfTask } = originalTask;
                    const duplicatedTaskData = {
                        ...restOfTask,
                        requester: user.email.split('@')[0],
                        title: `[CÓPIA] ${originalTask.title}`,
                    };
                    setTaskToDuplicate(duplicatedTaskData);
                    setIsFormModalOpen(true);
                }
            };
            
            const confirmDeleteTask = (taskId) => { setTaskToDelete(taskId); setIsDeleteModalOpen(true); };

            const handleDeleteTask = async () => {
                if (!taskToDelete) return;
                await deleteDoc(doc(db, "tasks", taskToDelete));
                closeAllModals();
            };
            
            const openTaskDetails = (task) => {
                setSelectedTask(task);
            };

            const closeAllModals = () => {
                setIsFormModalOpen(false);
                setSelectedTask(null);
                setIsDeleteModalOpen(false);
                setTaskToDelete(null);
                setTaskToDuplicate(null);
                setIsSettingsModalOpen(false);
            };

            const columnNames = ['A Fazer', 'Em Andamento', 'Em Aprovação', 'Concluído'];
            
            const columnStyles = {
                'A Fazer': 'bg-blue-100 border-blue-400',
                'Em Andamento': 'bg-yellow-100 border-yellow-400',
                'Em Aprovação': 'bg-purple-100 border-purple-400',
                'Concluído': 'bg-green-100 border-green-400',
            };

            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-800">
                    <header className="bg-white shadow-md p-4 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-40">
                        <div className="flex items-center gap-4">
                            {settings.logoUrl && <img src={settings.logoUrl} alt="Logo" className="h-10" onError={(e) => e.target.style.display='none'}/>}
                            <div>
                                <h1 className="text-xl md:text-2xl font-bold text-gray-700">{settings.companyName}</h1>
                                <p className="text-sm text-gray-500">Sistema de Gerenciamento de Artes</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center justify-center gap-2">
                            <div className="flex items-center bg-gray-200 rounded-lg p-1">
                                <button onClick={() => setView('board')} className={`flex items-center gap-2 py-1 px-3 rounded-md text-sm transition-colors ${view === 'board' ? 'bg-white shadow-sm' : 'hover:bg-gray-300'}`}><Columns className="h-5 w-5"/> Quadro</button>
                                <button onClick={() => setView('calendar')} className={`flex items-center gap-2 py-1 px-3 rounded-md text-sm transition-colors ${view === 'calendar' ? 'bg-white shadow-sm' : 'hover:bg-gray-300'}`}><CalendarDays className="h-5 w-5"/> Calendário</button>
                            </div>
                            <button onClick={() => setIsFormModalOpen(true)} className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105"><Plus className="h-5 w-5" /> Nova Solicitação</button>
                            {/* This is client-side authorization, for a real app use custom claims or security rules */}
                            {user.email === 'andercleidesigner@gmail.com' && (
                                <button onClick={() => setIsSettingsModalOpen(true)} className="p-2 rounded-full hover:bg-gray-200" title="Configurações"><Settings className="h-5 w-5"/></button>
                            )}
                            <button onClick={() => firebaseSignOut(auth)} className="flex items-center gap-2 text-red-500 hover:text-red-700 font-semibold"><LogOut className="h-5 w-5"/> Sair</button>
                        </div>
                    </header>

                    {loading ? <div className="flex justify-center items-center h-[calc(100vh-80px)]"><p>Carregando tarefas...</p></div> : (
                        <main className="p-4 md:p-8">
                            {view === 'board' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {columnNames.map(columnName => (
                                        <div key={columnName} className={`rounded-lg ${columnStyles[columnName]} p-1`}>
                                            <div className="p-3">
                                                <h2 className="font-bold text-lg mb-4 text-gray-700">{columnName} ({tasks.filter(t => t.status === columnName).length})</h2>
                                                <div className="space-y-4">
                                                    {tasks
                                                        .filter(t => t.status === columnName)
                                                        .sort((a, b) => (a.dueDate?.seconds || 0) - (b.dueDate?.seconds || 0))
                                                        .map(task => <TaskCard key={task.id} task={task} onDuplicate={handleDuplicateTask} onClick={() => openTaskDetails(task)} />)
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {view === 'calendar' && <CalendarView tasks={tasks} onTaskClick={openTaskDetails} />}
                        </main>
                    )}

                    {isFormModalOpen && <TaskFormModal user={user} onClose={closeAllModals} onSave={handleAddTask} initialData={taskToDuplicate}/>}
                    {selectedTask && <TaskDetailModal user={user} task={selectedTask} onClose={closeAllModals} onUpdate={handleUpdateTask} onDelete={confirmDeleteTask}/>}
                    {isDeleteModalOpen && <ConfirmationModal message="Tem certeza que deseja excluir esta tarefa?" onConfirm={handleDeleteTask} onCancel={closeAllModals} />}
                    {isSettingsModalOpen && <SettingsModal currentSettings={settings} onSave={handleSaveSettings} onClose={closeAllModals} />}
                </div>
            );
        };
        
        const AuthScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("Falha no login. Verifique seu e-mail e senha.");
                    console.error("Auth Error:", err);
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold text-center">Login</h2>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="text-sm font-bold text-gray-600 block">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md mt-1" required />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-600 block">Senha</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md mt-1" required />
                            </div>
                            {error && <p className="text-sm text-red-500">{error}</p>}
                            <div>
                                <button type="submit" disabled={isLoading} className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-md text-white text-sm disabled:opacity-50">
                                    {isLoading ? 'Entrando...' : 'Entrar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, user => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return <div className="flex justify-center items-center h-screen"><p>Carregando...</p></div>;
            }

            return user ? <TaskManager user={user} /> : <AuthScreen />;
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

